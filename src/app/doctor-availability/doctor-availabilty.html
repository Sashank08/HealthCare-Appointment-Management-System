<div class="container-fluid bg-light min-vh-100 py-4">
  <div class="container">
    <!-- Header -->
    <div class="bg-primary text-white p-4 rounded-top text-center">
      <h1 class="h2 mb-2">
        <i class="fas fa-clock me-2"></i>
        <span *ngIf="userRole === 'DOCTOR'">Doctor Availability Management</span>
        <span *ngIf="userRole === 'PATIENT'">Find Available Doctors</span>
        <span *ngIf="!userRole">Doctor Availability System</span>
      </h1>
      <p class="mb-0 opacity-75">
        <span *ngIf="userRole === 'DOCTOR'">Manage your appointment schedule and availability slots</span>
        <span *ngIf="userRole === 'PATIENT'">Search and book appointments with available doctors</span>
        <span *ngIf="!userRole">Please login to access personalized features</span>
      </p>
    </div>
    
    <div class="bg-white rounded-bottom shadow p-4">
      <!-- Search Section -->
      <div class="d-flex justify-content-between align-items-center mb-4 pb-3 border-bottom">
        <h3 class="h4 mb-0">
          <span *ngIf="userRole === 'DOCTOR'">My Schedule</span>
          <span *ngIf="userRole === 'PATIENT'">Find Doctors</span>
          <span *ngIf="!userRole">Search Availability</span>
        </h3>
        <div *ngIf="userRole === 'DOCTOR'" class="btn-group" role="group">
          <button class="btn btn-sm" [class.btn-primary]="!showAppointments" [class.btn-outline-primary]="showAppointments" (click)="showAppointments = false">Availability</button>
          <button class="btn btn-sm" [class.btn-primary]="showAppointments" [class.btn-outline-primary]="!showAppointments" (click)="toggleAppointmentsView()">Appointments</button>
        </div>
      </div>
      
      <div class="row g-3 mb-4">
        <div class="col-md-3">
          <label class="form-label fw-semibold">
            <span *ngIf="userRole === 'PATIENT'">Doctor ID (Optional)</span>
            <span *ngIf="userRole === 'DOCTOR'">Your Doctor ID</span>
            <span *ngIf="!userRole">Doctor ID</span>
          </label>
          <input type="number" [(ngModel)]="searchDoctorID" class="form-control" 
                 [placeholder]="userRole === 'DOCTOR' ? 'Auto-filled' : userRole === 'PATIENT' ? 'Leave empty for all' : 'Enter Doctor ID'" 
                 min="1">
        </div>
        <div class="col-md-3">
          <label class="form-label fw-semibold">From Date</label>
          <input type="date" [(ngModel)]="startDate" class="form-control">
        </div>
        <div class="col-md-3">
          <label class="form-label fw-semibold">To Date</label>
          <input type="date" [(ngModel)]="endDate" class="form-control">
        </div>
        <div class="col-md-3 d-flex align-items-end">
          <button (click)="searchAvailability()" class="btn btn-primary w-100" [disabled]="isLoading">
            <span *ngIf="!isLoading">
              <span *ngIf="userRole === 'DOCTOR'">View Schedule</span>
              <span *ngIf="userRole === 'PATIENT'">Search Doctors</span>
              <span *ngIf="!userRole">Search</span>
            </span>
            <span *ngIf="isLoading">Searching...</span>
          </button>
        </div>
      </div>

      <!-- Feedback Message -->
      <div *ngIf="message" class="alert" [class.alert-success]="messageType === 'success'" [class.alert-danger]="messageType === 'error'" [class.alert-warning]="messageType === 'warning'">
        <i class="fas" [class.fa-check-circle]="messageType === 'success'" [class.fa-exclamation-triangle]="messageType === 'warning'" [class.fa-times-circle]="messageType === 'error'"></i>
        {{ message }}
      </div>

      <!-- Appointments View -->
      <div *ngIf="showAppointments && userRole === 'DOCTOR'">
        <h4 class="mb-3">Scheduled Appointments</h4>
        <div *ngIf="appointments.length > 0" class="alert alert-info">
          <strong>{{appointments.length}} Total Appointments</strong>
        </div>
        <div *ngIf="appointments.length > 0" class="table-responsive">
          <table class="table table-hover">
            <thead class="table-light">
              <tr>
                <th>#</th>
                <th>Patient</th>
                <th>Date</th>
                <th>Time</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let appointment of appointments; let i = index">
                <td>{{ i + 1 }}</td>
                <td>{{ appointment.patientName }}</td>
                <td>{{ appointment.date }}</td>
                <td>{{ appointment.slot }}</td>
                <td>
                  <span class="badge" 
                        [class.bg-success]="appointment.status === 'Completed'"
                        [class.bg-warning]="appointment.status === 'In Progress'"
                        [class.bg-primary]="appointment.status === 'Upcoming'">
                    {{ appointment.status }}
                  </span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <div *ngIf="appointments.length === 0" class="text-center py-5 text-muted">
          <i class="fas fa-calendar-times fa-3x mb-3"></i>
          <p>No appointments scheduled yet.</p>
        </div>
      </div>

      <!-- Availability View -->
      <div *ngIf="!showAppointments && availabilities && availabilities.length > 0">
        <h4 class="mb-3">
          <span *ngIf="userRole === 'DOCTOR'">Your Availability Schedule</span>
          <span *ngIf="userRole === 'PATIENT'">Available Doctors</span>
          <span *ngIf="!userRole">Available Schedules</span>
        </h4>
        
        <div *ngIf="userRole === 'PATIENT'" class="alert alert-success">
          <strong>Found {{availabilities.length}} available doctor(s)</strong> - Click "Book" to schedule your appointment
        </div>
        
        <div *ngIf="userRole === 'DOCTOR'" class="alert alert-warning">
          <strong>Schedule Overview:</strong> Managing {{availabilities.length}} availability slot(s)
        </div>
        
        <div class="table-responsive">
          <table class="table table-hover">
            <thead class="table-light">
              <tr>
                <th>#</th>
                <th>Doctor</th>
                <th>Date</th>
                <th>Available Slots</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let availability of availabilities; let i = index">
                <td>{{ i + 1 }}</td>
                <td>
                  <div>
                    <strong>{{ availability.doctorName || 'Dr. Atul Sahu' }}</strong><br>
                    <small class="text-muted">ID: {{ availability.doctorID }}</small><br>
                    <span *ngIf="availability.specialty" class="badge bg-info">{{ availability.specialty }}</span>
                  </div>
                </td>
                <td>{{ availability.date }}</td>
                <td>
                  <div class="d-flex flex-wrap gap-1">
                    <span *ngFor="let slot of availability.timeSlots" class="badge bg-light text-dark border">{{ slot }}</span>
                  </div>
                </td>
                <td>
                  <div class="btn-group-vertical btn-group-sm" role="group">
                    <button *ngIf="canManageAvailability() && isCurrentDoctor(availability.doctorID)" 
                            (click)="openUpdateModal(availability)" class="btn btn-warning btn-sm">Edit</button>
                    <button *ngIf="canManageAvailability() && isCurrentDoctor(availability.doctorID)" 
                            (click)="deleteAvailability(availability.doctorID, availability.date)" class="btn btn-danger btn-sm">Delete</button>
                    <button *ngIf="userRole === 'PATIENT'" 
                            class="btn btn-success btn-sm" (click)="bookAppointment(availability)">Book</button>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Add Availability Form -->
      <div *ngIf="canManageAvailability()" class="mt-5">
        <div class="card">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Add New Availability</h5>
          </div>
          <div class="card-body">
            <div class="alert alert-info">
              <strong>Doctor Portal:</strong> Create your availability slots for patient appointments
            </div>
            <form (ngSubmit)="onSubmit()" #addForm="ngForm">
              <div class="row g-3 mb-3">
                <div class="col-md-4">
                  <label for="doctorID" class="form-label fw-semibold">Doctor ID <span class="text-danger">*</span></label>
                  <input type="number" id="doctorID" name="doctorID" [(ngModel)]="doctorID" required min="1" 
                         class="form-control" readonly>
                  <div class="form-text">Auto-filled from your profile</div>
                </div>
                <div class="col-md-4">
                  <label for="doctorName" class="form-label fw-semibold">Doctor Name</label>
                  <input type="text" id="doctorName" name="doctorName" [(ngModel)]="doctorName" 
                         class="form-control" readonly>
                  <div class="form-text">Auto-filled from your profile</div>
                </div>
                <div class="col-md-4">
                  <label for="specialty" class="form-label fw-semibold">Specialty</label>
                  <input type="text" id="specialty" name="specialty" [(ngModel)]="specialty" 
                         class="form-control" readonly>
                  <div class="form-text">Auto-filled from your profile</div>
                </div>
              </div>
              <div class="mb-3">
                <label for="date" class="form-label fw-semibold">Date <span class="text-danger">*</span></label>
                <input type="date" id="date" name="date" [(ngModel)]="date" required class="form-control">
                <div class="form-text">Select a future date for availability</div>
              </div>
              <div class="mb-3">
                <label class="form-label fw-semibold">Select Time Slots (Max 8 slots) <span class="text-danger">*</span></label>
                <div class="row g-2">
                  <div class="col-md-3" *ngFor="let slot of availableTimeSlots">
                    <button type="button" class="btn w-100" 
                            [class.btn-primary]="isSlotSelected(slot)" 
                            [class.btn-outline-primary]="!isSlotSelected(slot)" 
                            (click)="toggleTimeSlot(slot)">
                      {{ slot }}
                    </button>
                  </div>
                </div>
                <div *ngIf="selectedTimeSlots && selectedTimeSlots.length > 0" class="mt-2 p-2 bg-light rounded">
                  <strong>Selected: </strong>{{ selectedTimeSlots.length }} slot(s)
                </div>
              </div>
              <button type="submit" class="btn btn-success" [disabled]="isSubmitting || !doctorID || !date || !selectedTimeSlots || selectedTimeSlots.length === 0">
                <span *ngIf="!isSubmitting">Add Availability</span>
                <span *ngIf="isSubmitting">Adding...</span>
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Update Modal -->
<div *ngIf="showUpdateModal" class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">Update Availability</h5>
        <button type="button" class="btn-close btn-close-white" (click)="closeUpdateModal()"></button>
      </div>
      <div class="modal-body">
        <form (ngSubmit)="onUpdateSubmit()" #updateForm="ngForm">
          <div class="mb-3">
            <label for="updateDoctorID" class="form-label fw-semibold">Doctor ID <span class="text-danger">*</span></label>
            <input type="number" id="updateDoctorID" name="updateDoctorID" [(ngModel)]="updateDoctorID" required min="1" class="form-control">
            <div class="form-text">Enter a valid doctor identification number</div>
          </div>
          <div class="mb-3">
            <label for="updateDate" class="form-label fw-semibold">Date <span class="text-danger">*</span></label>
            <input type="date" id="updateDate" name="updateDate" [(ngModel)]="updateDate" required class="form-control">
            <div class="form-text">Select a future date for availability</div>
          </div>
          <div class="mb-3">
            <label class="form-label fw-semibold">Select Time Slots (Max 8 slots) <span class="text-danger">*</span></label>
            <div class="row g-2">
              <div class="col-md-3" *ngFor="let slot of availableTimeSlots">
                <button type="button" class="btn btn-sm w-100" 
                        [class.btn-primary]="isUpdateSlotSelected(slot)" 
                        [class.btn-outline-primary]="!isUpdateSlotSelected(slot)" 
                        (click)="toggleUpdateTimeSlot(slot)">
                  {{ slot }}
                </button>
              </div>
            </div>
            <div *ngIf="updateSelectedTimeSlots && updateSelectedTimeSlots.length > 0" class="mt-2 p-2 bg-light rounded">
              <strong>Selected: </strong>{{ updateSelectedTimeSlots.length }} slot(s)
            </div>
          </div>
          <div class="d-flex justify-content-end gap-2">
            <button type="button" class="btn btn-secondary" (click)="closeUpdateModal()">Cancel</button>
            <button type="submit" class="btn btn-primary" [disabled]="isSubmitting || !updateDoctorID || !updateDate || !updateSelectedTimeSlots || updateSelectedTimeSlots.length === 0">
              <span *ngIf="!isSubmitting">Update Availability</span>
              <span *ngIf="isSubmitting">Updating...</span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>